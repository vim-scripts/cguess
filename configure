#! /bin/sh
# cguess - C/C++/Java(tm) auto-completion tool for VIM
# Copyright (C) 2005 Andrzej Zaborowski <balrogg@gmail.com>
# All Rights Reserved
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in
#    the documentation and/or other materials provided with the
#    distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS''
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
# THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
# PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR
# CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
# PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
# OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#

VERSION=snapshot
SCRIPT=$0

# Default values
PLUGIN=global
PREFIX=/usr/local
DEFINES="-DVERSION=${VERSION} -DNDEBUG"
CFLAGS="-O3 -Wall -std=gnu99 -fomit-frame-pointer -funroll-loops \
	${CFLAGS} ${DEFINES}"

# VIM check
# TODO: improve
echo -n probing vim...
echo echo \"\\n\" . \$VIM . \"/\\n\"	> config.vim
echo quit				>> config.vim
VIM=`vim -S config.vim -T dumb -e | grep vim | sed s/[^\\ a-zA-Z0-9_/-]//g`
# also we could do vim --version | grep fallback something
# or ask pkg-config but it perhaps would't know
echo \ seems ok

# TODO: GCC check, gather includes and CFLAGS

# bison check
# TODO: check for other versions that work, too
echo -n probing bison...
if test "`bison --version 2>/dev/null | grep 1\\.875`" >/dev/null 2>&1; then
	echo \ seems ok
else
	echo \ using dist files
	cp c++.c-dist c++.c
	cp y.tab.h-dist y.tab.h
fi

# Processing arguments
while test $# -ne 0; do
	case "$1" in
	--debug)	VERSION=${VERSION}debug
			CFLAGS="-Wall -std=gnu99 -g -ggdb \
			-DVERSION=${VERSION}";;
	--prefix=*)	PREFIX=`echo "$1"|sed s/--prefix=//g`;;
	--local)	PLUGIN=local;;
	--global)	PLUGIN=global;;
	--noplugin)	PLUGIN=no;;
	--vim=*)	VIM=`echo "$1"|sed s/--vim=//g`;;
	--help)
		echo Usage:
		echo -e \\t${SCRIPT} [--debug] [--prefix=path] \
			[--local \| --global \| --noplugin] [--vim=path]
		echo -e \\t${SCRIPT} --help
		echo
		echo Environment variables that may influence \
			the configuration:
		echo -e \\tCFLAGS
		echo
		exit -1
		;;
	*)	echo unknown option \"$1\"
	esac
	shift
done

if [ "${PLUGIN}" = "global" ]; then
	PLUGIN_INSTALL_DIR="$VIM/vim*/plugin"
elif [ "${PLUGIN}" = "local" ]; then
	PLUGIN_INSTALL_DIR="${HOME}/.vim/plugin"
else
	PLUGIN_INSTALL_DIR=""
fi

echo -n writing config...

echo \# Generated by ${SCRIPT}		> config

echo YFLAGS=-d \# rvtk			>> config
echo LFLAGS=-f -Ca			>> config
echo CFLAGS=${CFLAGS}			>> config
echo PREFIX=${PREFIX}			>> config
echo PLUGIN_DIR=${PLUGIN_INSTALL_DIR}	>> config
echo INSTALL=install			>> config
echo VERSION=${VERSION}			>> config
echo YACC=bison --yacc			>> config
echo LD=\$\(CC\)			>> config
echo RM=rm -f				>> config

echo \ seems ok
